"use strict";const e=require("../../common/vendor.js");var t={VITE_CJS_IGNORE_WARNING:"true",VITE_USER_NODE_ENV:"production",VITE_ROOT_DIR:"/Volumes/DataExt/work/sanli/frontend",BASE_URL:"/",MODE:"build",DEV:!1,PROD:!0,SSR:!1};const n="modelCanvas",o="3D 模型预览",i={__name:"index",setup(i){let r="";try{r=(null==t?void 0:t.VITE_API_BASE_URL)||""}catch(mt){r=""}const l="string"!=typeof(a=r||"http://localhost:5001")?"":a.replace(/\/+$/,"");var a;const u=l?`${l}/api/materials`:"",s=e=>{if("string"!=typeof e||!e)return e;if(!l||(e=>"string"==typeof e&&/^https?:\/\//i.test(e))(e))return e;const t=e.startsWith("/")?e:`/${e}`;return`${l}${t}`},c=e=>Array.isArray(e)?e:[],d=(e={})=>Object.entries(e||{}).reduce((e,[t,n])=>(n&&"object"==typeof n&&(e[t]=((e={})=>({...e,price:Number(e.price)||0,background:c(e.background).map(e=>({...e,glb:s(e.glb),png:s(e.png)})),product:c(e.product).map(e=>({...e,glb:s(e.glb),png:s(e.png)}))}))(n)),e),{}),v=e.ref({}),m=e.ref(0),f=e.computed(()=>m.value.toLocaleString("zh-CN")),h=e.computed(()=>{const e=v.value||{};return Object.entries(e).map(([e,t])=>({id:e,...t,background:Array.isArray(null==t?void 0:t.background)?t.background:[],product:Array.isArray(null==t?void 0:t.product)?t.product:[]}))}),p=e.ref(0),g=e.ref(0),x=e.ref(0),y=e.ref(0),w=e.computed(()=>{const e=h.value;return e[p.value]||e[0]||{background:[],product:[]}}),b=e.computed(()=>{var e;return(null==(e=w.value)?void 0:e.name)||""});e.computed(()=>{const e=h.value;return e.length<=1?"":`${p.value+1}/${e.length}`});const T=e.computed(()=>{var e;return(null==(e=w.value)?void 0:e.background)??[]});e.watch(w,e=>{const t=Number(null==e?void 0:e.price);m.value=Number.isFinite(t)&&t>0?t:0},{immediate:!0});const E=(e,t)=>{const n=Number(e);return Number.isFinite(n)&&n>0?n/1e3:t},M=e.computed(()=>T.value.map((e,t)=>{const n=void 0!==e.length?`${e.length}cm`:e.name||`圈长${t+1}`,o=Number(e.radius);return{label:n,radius:Number.isFinite(o)?o:E(e.length,Ae.radius),glb:e.glb||"",raw:e}})),R=e.computed(()=>M.value.map(e=>e.label)),A=e.computed(()=>M.value[x.value]||M.value[0]||null),N=e.computed(()=>{var e;return(null==(e=A.value)?void 0:e.glb)||""}),S=e=>{if("number"==typeof e)return e/1e3;if("string"!=typeof e)return null;const t=e.match(/[\d.]+/);if(!t)return null;const n=Number(t[0]);return Number.isFinite(n)?e.includes("cm")?n/100:n/1e3:null},L=e.computed(()=>{var e;return(null==(e=w.value)?void 0:e.product)??[]}),k=e.computed(()=>{const e=new Map;return L.value.forEach(t=>{const n=t.width||t.diameter;n&&!e.has(n)&&e.set(n,{label:n,value:n,diameter:S(n)})}),e.size?Array.from(e.values()):[{label:"4mm",value:"4mm",diameter:.004}]}),F=e.computed(()=>k.value.map(e=>e.label)),z=e.computed(()=>k.value[y.value]||k.value[0]||null),P=e.computed(()=>{var e;const t=null==(e=z.value)?void 0:e.value,n=L.value;if(!t)return n;const o=n.filter(e=>(e.width||e.diameter)===t);return o.length?o:n}),C=e.computed(()=>P.value[g.value]||{}),$=e.computed(()=>{var e;return(null==(e=C.value)?void 0:e.glb)||""}),D=3*Math.PI/2,V=e.computed(()=>{var e;const t=Number(null==(e=C.value)?void 0:e.rotation);return Number.isFinite(t)?t:D}),j=e.computed(()=>{var e;const t=null==(e=C.value)?void 0:e.rotationAxis;return["radial","tangent","normal"].includes(t)?t:"radial"}),_=e.ref(null),B=e.ref("加载模型中..."),I=e.ref(!1),O=e.ref(0),G=e.ref(!1),W=e.ref(1/0),q=async e=>{(e=>{const t=P.value;if(!Array.isArray(t)||!t.length)return;if(!Number.isInteger(e))return;const n=Math.min(Math.max(e,0),t.length-1);g.value=n})(e),await vt()},Q=e=>{var t;const n=Number(null==(t=null==e?void 0:e.detail)?void 0:t.value);Number.isNaN(n)||(x.value=n)},U=e=>{var t;const n=Number(null==(t=null==e?void 0:e.detail)?void 0:t.value);Number.isNaN(n)||(y.value=n)},X={startX:0,startY:0,active:!1},Y={active:!1,releaseTimer:null},Z=(e=80)=>{Y.releaseTimer&&clearTimeout(Y.releaseTimer),Y.releaseTimer=setTimeout(()=>{Y.active=!1,Y.releaseTimer=null},e)},H=e=>{const t=h.value;if(!t.length)return;const n=Pe(e,t.length);n!==p.value&&(p.value=n)},J=e=>{var t;if(Y.active)return void(X.active=!1);const n=null==(t=null==e?void 0:e.touches)?void 0:t[0];n&&(X.startX=n.clientX,X.startY=n.clientY,X.active=!0)},K=e=>{var t;if(Y.active)return void(X.active=!1);if(!X.active)return;const n=null==(t=null==e?void 0:e.changedTouches)?void 0:t[0];if(!n)return void(X.active=!1);const o=n.clientX-X.startX,i=n.clientY-X.startY;Math.abs(o)<120||Math.abs(o)<Math.abs(i)||H(o<0?p.value+1:p.value-1),X.active=!1},ee=()=>{void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"正在生成",icon:"none"}):console.info("Generate video triggered")},te=()=>{},ne=async()=>{var t;if(u)try{const n=await(t=u,t?void 0!==e.index&&"function"==typeof e.index.request?new Promise((n,o)=>{e.index.request({url:t,method:"GET",success:e=>n(null==e?void 0:e.data),fail:e=>o(e)})}):"function"==typeof fetch?fetch(t).then(e=>{if(!e.ok)throw new Error(`请求失败: ${e.status}`);return e.json()}):Promise.reject(new Error("当前环境缺少网络请求能力")):Promise.reject(new Error("缺少请求地址")));n&&"object"==typeof n&&(v.value=d(n),p.value=0,x.value=0,y.value=0,g.value=0)}catch(mt){console.error("获取素材配置失败",mt),void 0!==e.index&&"function"==typeof e.index.showToast&&e.index.showToast({title:"素材数据加载失败",icon:"none"})}},oe=()=>{if(!Me.value.length)return void(void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"暂无可撤销操作",icon:"none"}):console.info("No undo actions available"));const t=Me.value.pop();if(!t)return;const n="object"==typeof t?e.toRaw(t):null,o=(null==n?void 0:n.marble)?e.toRaw(n.marble):null;let i=!1;if("add"===(null==n?void 0:n.type)?i=!!o&&nt(o,{record:!1}):"remove"===(null==n?void 0:n.type)&&(i=!!o&&tt(o,n.index)),!i)return Me.value.push(t),void(void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"撤销失败",icon:"none"}):console.warn("Undo failed"));void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"已撤销",icon:"none"}):console.info("Undo applied")},ie="function"==typeof requestAnimationFrame?requestAnimationFrame:e=>setTimeout(e,16),re="function"==typeof cancelAnimationFrame?cancelAnimationFrame:clearTimeout;let le=null,ae=null,ue=null,se=null,ce=null,de=null,ve=null,me=null,fe=null;const he=e.getCurrentInstance(),pe="undefined"!=typeof window&&"undefined"!=typeof document,ge=void 0!==e.wx$1&&"function"==typeof e.wx$1.createSelectorQuery;let xe=!0;const ye=new Map,we={diameter:0,thickness:0},be=new Map,Te=({diameter:e,thickness:t})=>{Number.isFinite(e)&&e>0&&(we.diameter=e),Number.isFinite(t)&&t>0&&(we.thickness=t)},Ee=[],Me=e.ref([]),Re=e.computed(()=>O.value>0&&Me.value.length>0),Ae={radius:.018,layerGap:.0012,offsetZ:0,bandThickness:0},Ne={minRadius:1/0,maxRadius:0},Se=new e.Vector3,Le={x:new e.Vector3(1,0,0),y:new e.Vector3(0,1,0),z:new e.Vector3(0,0,1)},ke={planeAxes:["x","y"],normalAxis:"z"},Fe=e.ref(o),ze=pe;e.watch(Fe,t=>{(t=>{const n=t||o;if("undefined"!=typeof document&&(document.title=n),void 0!==e.index&&"function"==typeof e.index.setNavigationBarTitle)try{e.index.setNavigationBarTitle({title:n})}catch(mt){console.warn("Failed to set navigation title",mt)}})(t)},{immediate:!0});const Pe=(e,t)=>Number.isInteger(e)?!Number.isInteger(t)||t<=0?0:Math.min(Math.max(e,0),t-1):0;let Ce=!1;const $e=async()=>{if(!Ce){Ce=!0;try{at(),await e.nextTick$1(),await lt()}catch(mt){console.error("重建场景失败",mt)}finally{Ce=!1}}},De=new e.Quaternion,Ve=new e.Vector2;let je=null,_e=null;const Be={active:!1,x:0,y:0},Ie=new e.Raycaster;let Oe=null,Ge=null,We=null;const qe=()=>{je&&(clearTimeout(je),je=null),_e=null,Be.active=!1},Qe=t=>{if(!t||"object"!=typeof t)return;const n={...t};if(n.marble&&"object"==typeof n.marble){const t=e.toRaw(n.marble);n.marble=t?e.markRaw(t):t}Me.value.push(n)},Ue=()=>{Me.value.length=0},Xe=()=>{const e=_.value;return e?e.$el??e:null};function Ye(e){return e&&"object"==typeof e?(e.style||(e.style={}),"function"!=typeof e.getBoundingClientRect&&(e.getBoundingClientRect=()=>({width:e.width||0,height:e.height||0,left:0,top:0})),"function"!=typeof e.getRootNode&&(e.getRootNode=()=>null),e):e}const Ze=()=>{if(!le||!ue)return;if(!ve)return;const t=ve.getBoundingClientRect?ve.getBoundingClientRect():{width:ve.width,height:ve.height},n=(()=>{if(void 0!==e.index&&"function"==typeof e.index.getSystemInfoSync){const{pixelRatio:t=1}=e.index.getSystemInfoSync();return Math.min(t,2)}return"undefined"!=typeof window?Math.min(window.devicePixelRatio||1,2):1})(),o=t.width,i=t.height;le.setPixelRatio(n),le.setSize(o,i,!1),ue.aspect=o/i,ue.updateProjectionMatrix()},He=t=>{if(!t||!ue||!se)return;const n=(new e.Box3).setFromObject(t);if(n.isEmpty())return;const o=n.getSize(new e.Vector3),i=n.getCenter(new e.Vector3);if(t.position.sub(i),(e=>{const t=[{axis:"x",length:e.x},{axis:"y",length:e.y},{axis:"z",length:e.z}].sort((e,t)=>e.length-t.length);ke.normalAxis=t[0].axis,ke.planeAxes=[t[1].axis,t[2].axis]})(o),Ke(t),!Number.isFinite(Ae.radius)||Ae.radius<=0){const e=Math.max(o.x,o.y,o.z)/2;e>0&&(Ae.radius=e)}(!Number.isFinite(Ae.bandThickness)||Ae.bandThickness<=0)&&(Ae.bandThickness=Math.max(o[ke.normalAxis]||0,0)),Ae.layerGap=Math.max(.8*(o[ke.normalAxis]||0),8e-4),Ae.offsetZ=0;const r=(Math.max(o.x,o.y,o.z)||1)/(2*Math.tan(ue.fov*Math.PI/360)),l=r/ue.aspect,a=1.3*Math.max(r,l)||1,u=new e.Vector3(1,.4,1).normalize();ue.position.copy(u).multiplyScalar(a);const s=a/100,c=Math.min(Math.max(s,.01),Math.max(a-.001,.01));ue.near=c,ue.far=Math.max(100*a,c+100),ue.updateProjectionMatrix(),se.target.set(0,0,0),se.minDistance=.35*a,se.maxDistance=6*a,se.update()},Je=t=>{if(!(null==t?void 0:t.index))return!0;const{array:n}=t.index;if(!(n instanceof Uint32Array))return!0;let o=0;for(let e=0;e<n.length;e++)if(n[e]>o&&(o=n[e]),o>=65535)return!1;const i=new Uint16Array(n.length);return i.set(n),t.setIndex(new e.BufferAttribute(i,1)),!0},Ke=e=>{if(!e)return;Ne.minRadius=1/0,Ne.maxRadius=0;const[t,n]=ke.planeAxes;if(e.updateMatrixWorld(!0),e.traverse(e=>{var o,i;if(!e.isMesh)return;const r=null==(i=null==(o=e.geometry)?void 0:o.attributes)?void 0:i.position;if(r)for(let l=0;l<r.count;l++){Se.fromBufferAttribute(r,l),e.localToWorld(Se);const o=Se[t],i=Se[n],a=Math.hypot(o,i);Number.isFinite(a)&&(Ne.minRadius=Math.min(Ne.minRadius,a),Ne.maxRadius=Math.max(Ne.maxRadius,a))}}),!Number.isFinite(Ne.minRadius)||!Number.isFinite(Ne.maxRadius))return;const o=(Ne.minRadius+Ne.maxRadius)/2;Ae.radius=o||Ae.radius,Ae.bandThickness=Math.max(Ne.maxRadius-Ne.minRadius,0)},et=e=>{let t=e;for(;t&&!Ee.includes(t);)t=t.parent;return t||null},tt=(e,t=Ee.length)=>{if(!ae||!e)return!1;const n=Math.min(Math.max(t,0),Ee.length);return ae.add(e),Ee.splice(n,0,e),O.value=Ee.length,W.value=1/0,ut(),!0},nt=(e,{record:t=!0}={})=>{var n;if(!e||!ae)return!1;const o=et(e);if(!o)return!1;const i=Ee.indexOf(o);return-1!==i&&(null==(n=o.removeFromParent)||n.call(o),ae.remove(o),Ee.splice(i,1),O.value=Ee.length,W.value=1/0,t&&Qe({type:"remove",marble:o,index:i}),ut(),!0)},ot=(t,n={})=>!!nt(t,n)&&(void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"已删除该珠子",icon:"none"}):console.info("Selected marble removed"),!0),it=(e,t)=>{if(qe(),_e=e,e){if((e=>{var t,n,o,i;const r=(null==(t=null==e?void 0:e.touches)?void 0:t[0])||(null==(n=null==e?void 0:e.changedTouches)?void 0:n[0])||(null==(i=null==(o=null==e?void 0:e.originalEvent)?void 0:o.touches)?void 0:i[0])||e,l=null==r?void 0:r.clientX,a=null==r?void 0:r.clientY;"number"==typeof l&&"number"==typeof a?(Be.active=!0,Be.x=l,Be.y=a):Be.active=!1})(t),!Number.isFinite(650))return ot(e),void(_e=null);je=setTimeout(()=>{const e=_e;_e=null,je=null,e&&ot(e)},650)}},rt=()=>{if(!ve||Oe)return;const e=ve,t=e=>{var t,n;if(!G.value)return;if(null==(t=e.preventDefault)||t.call(e),null==(n=e.stopPropagation)||n.call(e),Y.active=!0,Y.releaseTimer&&(clearTimeout(Y.releaseTimer),Y.releaseTimer=null),!(e=>{var t,n,o,i;if(!ve||!ve.getBoundingClientRect)return!1;const r=ve.getBoundingClientRect(),l=(null==(t=e.touches)?void 0:t[0])||(null==(n=e.changedTouches)?void 0:n[0])||(null==(i=null==(o=e.originalEvent)?void 0:o.touches)?void 0:i[0])||e,a=null==l?void 0:l.clientX,u=null==l?void 0:l.clientY;return"number"==typeof a&&"number"==typeof u&&(Ve.x=(a-r.left)/r.width*2-1,Ve.y=-((u-r.top)/r.height*2-1),!0)})(e))return void qe();const o=(()=>{if(!ue||0===Ee.length)return null;Ie.setFromCamera(Ve,ue);const e=Ie.intersectObjects(Ee,!0);if(!e.length)return null;const t=e.find(({object:e})=>et(e));return t&&et(t.object)||null})();o?it(o,e):qe()},n=e=>{var t,n,o,i;if(!Be.active)return;const r=(null==(t=null==e?void 0:e.touches)?void 0:t[0])||(null==(n=null==e?void 0:e.changedTouches)?void 0:n[0])||(null==(i=null==(o=null==e?void 0:e.originalEvent)?void 0:o.touches)?void 0:i[0])||e,l=null==r?void 0:r.clientX,a=null==r?void 0:r.clientY;if("number"!=typeof l||"number"!=typeof a)return;const u=Math.abs(l-Be.x),s=Math.abs(a-Be.y);(u>12||s>12)&&qe()},o=()=>{Z(),qe()},i=()=>{Z(),qe()},r=()=>{Z(),qe()};e.addEventListener("pointerdown",t),e.addEventListener("pointermove",n),e.addEventListener("pointerup",o),e.addEventListener("pointerleave",i),e.addEventListener("pointercancel",r),Oe=()=>{e.removeEventListener("pointerdown",t),e.removeEventListener("pointermove",n),e.removeEventListener("pointerup",o),e.removeEventListener("pointerleave",i),e.removeEventListener("pointercancel",r)}},lt=async()=>{if(ve=await new Promise(t=>{const o=e=>!(!e||"function"!=typeof e.getContext||(t(Ye(e)),0));if(ge){const i=(()=>{if(void 0!==e.index&&"function"==typeof e.index.createSelectorQuery){const t=e.index.createSelectorQuery();return"function"==typeof t.in&&(null==he?void 0:he.proxy)&&t.in(he.proxy),t}if(void 0!==e.wx$1&&"function"==typeof e.wx$1.createSelectorQuery){const t=e.wx$1.createSelectorQuery();return"function"==typeof t.in&&(null==he?void 0:he.proxy)&&t.in(he.proxy),t}return null})();return i?void i.select(`#${n}`).fields({node:!0,size:!0}).exec(e=>{const n=Array.isArray(e)?e[0]:e;n&&o(n.node)||t(null)}):void t(null)}if(pe){const e=Xe();if(e){const t="function"==typeof e.querySelector?e.querySelector("canvas"):null;if(o(t))return;if("undefined"!=typeof document){const t=document.createElement("canvas");return t.id=n,t.setAttribute("data-platform","h5"),t.style.width="100%",t.style.height="100%",t.style.display="block",t.style.borderRadius="inherit",e.appendChild(t),void o(t)}}}const i=Xe();if(!o(i)){if(void 0!==e.index&&"function"==typeof e.index.createSelectorQuery){const i=e.index.createSelectorQuery();return"function"==typeof i.in&&(null==he?void 0:he.proxy)&&i.in(he.proxy),void i.select(`#${n}`).fields({node:!0,size:!0}).exec(e=>{const n=Array.isArray(e)?e[0]:e;n&&o(n.node)||t(null)})}t(null)}}),!ve)return void(B.value="画布尚未准备好");(()=>{var t,n;if(ge&&!Ge&&ve)try{Ge=new e.WechatPlatform(ve),null==(n=null==(t=e.PLATFORM)?void 0:t.set)||n.call(t,Ge)}catch(mt){console.error("初始化小程序平台失败",mt)}})(),(()=>{if(!ge||!Ge||void 0===e.wx$1)return;if(We)return;const t=e=>{try{Ge.dispatchTouchEvent(e)}catch(mt){console.warn("触摸事件派发失败",mt)}},n=n=>{const o=e.wx$1[`on${n}`];"function"==typeof o&&o(t)},o=n=>{const o=e.wx$1[`off${n}`];"function"==typeof o&&o(t)};n("TouchStart"),n("TouchMove"),n("TouchEnd"),n("TouchCancel"),We=()=>{try{o("TouchStart"),o("TouchMove"),o("TouchEnd"),o("TouchCancel")}catch(mt){console.warn("解绑触摸事件失败",mt)}We=null}})(),G.value=!1;const t=(()=>{if(!ve||"function"!=typeof ve.getContext)return null;const e={alpha:!0,antialias:!0,preserveDrawingBuffer:!0};return((...t)=>{for(const n of t){const t=ve.getContext(n,e);if(t)return t}return null})("webgl","experimental-webgl","webgl2","experimental-webgl2")})();if(!t)return void(B.value="当前环境不支持 WebGL 渲染");ae=new e.Scene,ae.background=new e.Color("#ffffff"),ue=new e.PerspectiveCamera(45,1,.1,100),ue.position.set(0,1,4),le=new e.WebGLRenderer({canvas:ve,context:t,alpha:!0,antialias:!0,preserveDrawingBuffer:!0}),"outputColorSpace"in le&&void 0!==le.outputColorSpace?le.outputColorSpace="srgb":"outputEncoding"in le&&(le.outputEncoding=e.sRGBEncoding),xe=le.capabilities.isWebGL2||!!le.extensions.get("OES_element_index_uint"),me=new e.PMREMGenerator(le),me.compileEquirectangularShader(),fe=me.fromScene(new e.RoomEnvironment(le),.04).texture,ae.environment=fe,Ze(),(()=>{if(ve){if("undefined"!=typeof ResizeObserver){const e=new ResizeObserver(()=>Ze());return e.observe(ve),void(de=()=>e.disconnect())}if(void 0!==e.index&&"function"==typeof e.index.onWindowResize){const t=()=>Ze();return e.index.onWindowResize(t),void(de=()=>{"function"==typeof e.index.offWindowResize&&e.index.offWindowResize(t)})}if("undefined"!=typeof window){const e=()=>Ze();window.addEventListener("resize",e),de=()=>window.removeEventListener("resize",e)}}})(),rt(),(()=>{const t=new e.HemisphereLight(16777215,1776411,1.2);ae.add(t);const n=new e.DirectionalLight(16777215,.8);n.position.set(5,10,7.5),ae.add(n);const o=new e.PointLight(7842559,.4);o.position.set(-4,-2,-3),ae.add(o)})();const o=(null==le?void 0:le.domElement)||ve,i=o&&Ye(o)||{addEventListener:()=>{},removeEventListener:()=>{},dispatchEvent:()=>!1,style:{},ownerDocument:null,getBoundingClientRect:()=>({width:0,height:0,left:0,top:0}),getRootNode:()=>null};se=new e.OrbitControls(ue,i),se.enableDamping=!0,se.dampingFactor=.08,se.enablePan=!1,se.minDistance=1.5,se.maxDistance=6,se.autoRotate=!1;try{const t=await new Promise((t,n)=>{const o=N.value;o?(new e.GLTFLoader).load(o,e=>{var o;const i=e.scene||(null==(o=e.scenes)?void 0:o[0]);i?(i.traverse(e=>{var t,o;e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0,!xe&&(null==(o=null==(t=e.geometry)?void 0:t.index)?void 0:o.array)instanceof Uint32Array&&(Je(e.geometry)||n(new Error("模型索引数量超过 WebGL1 能力，请换用 WebGL2 环境或重新导出模型"))))}),ae.add(i),t(i)):n(new Error("GLTF 中未找到可渲染的场景"))},void 0,e=>n(e)):n(new Error("未找到手串模型"))});He(t),B.value="",G.value=!0}catch(mt){console.error("模型加载失败",mt),B.value="模型加载失败，请确认文件是否存在",void 0!==e.index&&"function"==typeof e.index.showToast&&e.index.showToast({title:"模型加载失败",icon:"none"})}(()=>{const e=()=>{var t,n;null==(t=null==se?void 0:se.update)||t.call(se),null==(n=null==le?void 0:le.render)||n.call(le,ae,ue),ce=ie(e)};e()})()},at=()=>{var t,n,o,i,r,l,a,u,s,c;if(null!==ce&&(re(ce),ce=null),ae&&Ee.length&&Ee.forEach(e=>ae.remove(e)),null==(t=null==se?void 0:se.dispose)||t.call(se),null==(n=null==le?void 0:le.dispose)||n.call(le),null==(o=null==ae?void 0:ae.traverse)||o.call(ae,e=>{var t,n,o,i;e.isMesh&&(null==(n=null==(t=e.geometry)?void 0:t.dispose)||n.call(t),Array.isArray(e.material)?e.material.forEach(e=>{var t;return null==(t=null==e?void 0:e.dispose)?void 0:t.call(e)}):null==(i=null==(o=e.material)?void 0:o.dispose)||i.call(o))}),le=null,ae=null,ue=null,se=null,ve=null,null==(i=null==fe?void 0:fe.dispose)||i.call(fe),fe=null,null==(r=null==me?void 0:me.dispose)||r.call(me),me=null,"function"==typeof We&&We(),Ge)try{null==(a=null==(l=Ge.window)?void 0:l.cancelAnimationFrame)||a.call(l,ce)}catch(mt){console.warn("平台动画停止失败",mt)}if(Ge){try{null==(s=null==(u=e.PLATFORM)?void 0:u.dispose)||s.call(u),null==(c=null==Ge?void 0:Ge.dispose)||c.call(Ge)}catch(mt){console.warn("清理 WechatPlatform 失败",mt)}Ge=null}qe(),Ue();try{null==Oe||Oe()}catch(mt){console.warn("pointerTeardown failed",mt)}finally{Oe=null}ye.clear(),be.clear(),Ee.length=0,O.value=0,G.value=!1,W.value=1/0,Ne.minRadius=1/0,Ne.maxRadius=0,Ae.bandThickness=0,"function"==typeof de&&(de(),de=null)};e.onMounted(async()=>{await ne(),await e.nextTick$1(),await lt()}),e.onBeforeUnmount(()=>{at(),Y.releaseTimer&&(clearTimeout(Y.releaseTimer),Y.releaseTimer=null)});const ut=()=>{ae&&Ee.length&&Ee.forEach((e,t)=>{var n;const o=(null==(n=e.userData.bounds)?void 0:n.diameter)||we.diameter||.004,i=ct(t,o);if(!i)return;const r=e.userData.rotationConfig||{rotation:D,axis:"radial"};dt(e,i,r)})},st=(e,t)=>{const n=1.02*Math.max(e||.004,5e-4),o=Math.min(Math.max(n/(2*t),0),1);return o>0?2*Math.asin(o):0},ct=(t,n)=>{var o,i;const r=Math.max(Ae.radius,.001),l=2*Math.PI;let a=0;for(let u=0;u<=t;u++){const s=u===t,c=Ee[u],d=s?n:(null==(i=null==(o=null==c?void 0:c.userData)?void 0:o.bounds)?void 0:i.diameter)??we.diameter??.004,v=st(d,r);if(s){if(a+v>l)return null;const t=a+v/2,[n,o]=ke.planeAxes,i=ke.normalAxis,r=(Ae.bandThickness||0)/2,u=Math.max(Ae.radius+r,d/2||.002),s=new e.Vector3;return s.addScaledVector(Le[n],Math.cos(t)*u),s.addScaledVector(Le[o],Math.sin(t)*u),s.addScaledVector(Le[i],Ae.offsetZ),s}a+=v}return null};e.watch(M,e=>{const t=Pe(x.value,e.length);x.value=t},{immediate:!0}),e.watch(k,e=>{const t=Pe(y.value,e.length);y.value=t},{immediate:!0}),e.watch(P,e=>{e.length?g.value=Pe(g.value,e.length):g.value=0},{immediate:!0}),e.watch(w,()=>{g.value=0,x.value=0,y.value=0,ae&&Ee.length&&Ee.forEach(e=>ae.remove(e)),Ee.length=0,O.value=0,W.value=1/0,Ue(),$e()},{flush:"post"}),e.watch(b,e=>{Fe.value=e||o},{immediate:!0}),e.watch(A,e=>{(null==e?void 0:e.radius)&&Number.isFinite(e.radius)&&(Ae.radius=e.radius),ut()},{immediate:!0}),e.watch(z,e=>{const t=(null==e?void 0:e.diameter)||.004;we.diameter=t,we.thickness=t,ut()},{immediate:!0}),e.watch(N,(e,t)=>{e&&t&&e!==t&&$e()});const dt=(e,t,{rotation:n=D,axis:o="radial"}={})=>{if(!e||!t)return;const i=Le[ke.normalAxis]||Le.z;e.up.copy(i),e.position.copy(t),e.lookAt(0,0,0);const r=t.clone();if(0===r.lengthSq())return;r.normalize();const l=Se.clone().crossVectors(i,r);if(l.lengthSq()>0&&l.normalize(),De.setFromAxisAngle(r,Math.PI/2),e.applyQuaternion(De),!n)return;let a=r;"tangent"===o&&l.lengthSq()>0?a=l:"normal"===o&&(a=i.clone().normalize()),a.lengthSq()>0&&e.rotateOnWorldAxis(a,n)},vt=async()=>{if(!ae||I.value)return;const t=$.value;if(t){I.value=!0;try{const n=await(t=>{if(!t)return Promise.reject(new Error("未提供有效的产品模型路径"));if(ye.has(t)){const e=ye.get(t),n=be.get(t);return n&&Te(n),Promise.resolve(e)}return new Promise((n,o)=>{(new e.GLTFLoader).load(t,i=>{var r;const l=i.scene||(null==(r=i.scenes)?void 0:r[0]);if(!l)return void o(new Error("产品模型缺少可渲染场景"));const a=new e.Group,u=l.clone(!0),s=(new e.Box3).setFromObject(u),c=s.getSize(new e.Vector3),d=Math.min(c.x,c.y,c.z),v=Math.max(c.x,c.y,c.z),m={diameter:d||we.diameter,thickness:v||we.thickness};be.set(t,m);const f=s.getCenter(new e.Vector3);u.position.sub(f),a.add(u),ye.set(t,a),n(a)},void 0,e=>o(e))})})(t),o=be.get(t)||{diameter:we.diameter||.004,thickness:we.thickness||.002},i=n.clone(!0);i.traverse(e=>{e.userData.marbleRoot=i,e.userData.product=C.value,e.userData.bounds=o}),o&&Te(o);const r=(null==o?void 0:o.diameter)||we.diameter||.004,l=ct(Ee.length,r);if(!l)throw W.value=O.value,new Error("弹珠数量超出一圈容量");const a={rotation:V.value,axis:j.value};i.userData.rotationConfig=a,dt(i,l,a),ae.add(i),Ee.push(i),O.value=Ee.length,W.value=1/0,Qe({type:"add",marble:i}),ut()}catch(mt){console.error("添加珠子失败",mt),void 0!==e.index&&"function"==typeof e.index.showToast&&e.index.showToast({title:"无法继续添加珠子",icon:"none"})}finally{I.value=!1}}else void 0!==e.index&&"function"==typeof e.index.showToast&&e.index.showToast({title:"未找到产品模型",icon:"none"})};return(t,o)=>e.e({a:e.unref(ze)},e.unref(ze)?{b:e.t(Fe.value)}:{},{c:e.t(f.value),d:e.o(ee),e:e.t(R.value[x.value]),f:x.value,g:R.value,h:e.o(Q),i:e.t(F.value[y.value]),j:y.value,k:F.value,l:e.o(U),m:n,n:n,o:B.value},B.value?{p:e.t(B.value)}:{},{q:P.value.length},P.value.length?{r:Re.value?"":1,s:!Re.value,t:e.o(oe)}:{},{v:P.value.length},P.value.length?{w:e.f(P.value,(t,n,o)=>e.e({a:t.png},t.png?{b:t.png}:{},{c:e.t(t.name),d:t.name||n,e:g.value===n?1:"",f:e.o(e=>q(n),t.name||n)})),x:e.o(te),y:e.o(te),z:e.o(te)}:{},{A:e.o(J),B:e.o(K)})}},r=e._export_sfc(i,[["__scopeId","data-v-aeaad2e2"]]);wx.createPage(r);
